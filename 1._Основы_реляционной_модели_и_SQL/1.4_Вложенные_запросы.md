# 1.4 Вложенные запросы
Синонимы: вложенный запрос, подзапрос, внутренний запрос.

Исходная таблица:
```
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```
## Вложенный запрос, возвращающий одно значение
Может использоваться в условии отбора записей `WHERE` как обычное значение совместно с операциями =, <>, >=, <=, >, <.

**Пример**

Вывести информацию о самых дешевых книгах, хранящихся на складе.
```SQL
SELECT title, author, price, amount
FROM book
WHERE price = (
         SELECT MIN(price) 
         FROM book );
```
#### Задание
Вывести информацию (автора, название и цену) о  книгах, цены которых меньше или равны средней цене книг на складе. Информацию вывести в отсортированном по убыванию цены виде. Среднее вычислить как среднее по цене книги.
```SQL
SELECT author, title, price
FROM book
WHERE price <= (SELECT AVG(price) FROM book)
ORDER BY price DESC;
```
## Использование вложенного запроса в выражении
Опять рассмотрим вложенный запрос, возвращающий одной значение. Это значение также можно использовать в разных выражениях (сложение, вычитание и т.п.).

**Пример**

Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3. То есть нужно вывести и те книги, количество экземпляров которых меньше среднего на 3, или больше среднего на 3.
```SQL
SELECT title, author, amount 
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) > 3;
```
#### Задание
Вывести информацию (автора, название и цену) о тех книгах, цены которых превышают минимальную цену книги на складе не более чем на 150 рублей в отсортированном по возрастанию цены виде.
```SQL
SELECT author, title, price FROM book 
WHERE price - (SELECT MIN(price) FROM book) <= 150
ORDER BY price
```
## Вложенный запрос, возвращающий несколько значений. Оператор `IN`.
Вложенный запрос, возвращающий несколько значений одного столбца, можно использовать в разделе `WHERE` совместно с оператором `IN` (`NOT IN`).
```SQL
WHERE имя_столбца IN (вложенный запрос, возвращающий один столбец)
```
**Пример**

Вывести информацию о книгах тех авторов, общее количество экземпляров книг которых не менее 12.
```SQL
SELECT title, author, amount, price FROM book
WHERE author IN (
        SELECT author FROM book 
        GROUP BY author 
        HAVING SUM(amount) >= 12 );
```
```
+-----------------------+------------------+--------+--------+
| title                 | author           | amount | price  |
+-----------------------+------------------+--------+--------+
| Идиот                 | Достоевский Ф.М. | 10     | 460.00 |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 799.01 |
| Игрок                 | Достоевский Ф.М. | 10     | 480.50 |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 650.00 |
+-----------------------+------------------+--------+--------+
```
#### Задание
Вывести информацию (автора, книгу и количество) о тех книгах, количество экземпляров которых в таблице `book` не дублируется.
```SQL
SELECT author, title, amount FROM book
WHERE amount NOT IN
    (SELECT amount FROM book 
     GROUP BY amount 
     HAVING COUNT(amount) >= 2);
```
```
+---------------+-----------------------+--------+
| author        | title                 | amount |
+---------------+-----------------------+--------+
| Булгаков М.А. | Белая гвардия         | 5      |
| Есенин С.А.   | Стихотворения и поэмы | 15     |
+---------------+-----------------------+--------+
```
## Вложенный запрос, возвращающий несколько значений. Операторы `ANY`, `ALL`.
Вложенный запрос, возвращающий несколько значений одного столбца, можно использовать для отбора записей с помощью операторов `ANY` и `ALL` совместно с операциями отношения (=, <>, <=, >=, <, >).

Операторы `ANY` и `ALL` можно использовать ТОЛЬКО с вложенными запросами.

Примеры использования `ANY`:
* `amount > ANY (10, 12)` эквивалентно `amount > 10`
* `amount < ANY (10, 12)` эквивалентно `amount < 12`
* `amount = ANY (10, 12)` эквивалентно `(amount = 10) OR (amount = 12)`, а также amount `IN  (10,12)`
* `amount <> ANY (10, 12)` вернет все записи с любым значением amount, включая 10 и 12

Примеры использования `ALL`:
* `amount > ALL (10, 12)` эквивалентно `amount > 12`
* `amount < ALL (10, 12)` эквивалентно `amount < 10`
* `amount = ALL (10, 12)` не вернет ни одной записи, так как эквивалентно `(amount = 10) AND (amount = 12)`
* `amount <> ALL (10, 12)` вернет все записи кроме тех,  в которых amount равно 10 или 12

**Пример**

Вывести информацию о тех книгах, количество которых меньше самого маленького среднего количества книг каждого автора.
```SQL
SELECT AVG(amount) FROM book GROUP BY author
```
Нашли средние количества книг по авторам:
```
+-------------+
| AVG(amount) |
+-------------+
| 4.0000      |
| 7.6667      |
| 15.0000     |
+-------------+
```
Заберем этот ответ, чтобы сравнивать с количесвами по всем книгам. Должность быть меньше самого маленько, то есть меньше всех из ответа.
```SQL
SELECT title, author, amount, price FROM book
WHERE amount < ALL( SELECT AVG(amount) FROM book GROUP BY author );
```
```
+--------------------+------------------+--------+--------+
| title              | author           | amount | price  |
+--------------------+------------------+--------+--------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 670.99 |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 799.01 |
+--------------------+------------------+--------+--------+
```
**Пример**

Вывести информацию о тех книгах, количество которых меньше самого большого среднего количества книг каждого автора.
```SQL
SELECT title, author, amount, price FROM book
WHERE amount < ANY( SELECT AVG(amount) FROM book GROUP BY author );
```
## Вложенный запрос после `SELECT` как столбец.
Если вложенный запрос расплагается после ключевого слова `SELECT`, то результат выполнения запроса выводится в отдельном столбце результирующей таблицы. При этом результатом запроса может быть только одно значение, которое растиражируется на все строки.

**Пример**

Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3,  а также указать среднее значение количества экземпляров книг. Подзапрос `SELECT AVG(amount) FROM book` выдает среднее значение 7.6667.
```SQL
SELECT title, author, amount, 
    (SELECT AVG(amount) FROM book) AS Среднее_количество 
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) > 3;
```
```
+-----------------------+------------------+--------+--------------------+
| title                 | author           | amount | Среднее_количество |
+-----------------------+------------------+--------+--------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7.6667             |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7.6667             |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 7.6667             |
+-----------------------+------------------+--------+--------------------+
```
#### Задание
Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе стало одинаковое количество экземпляров каждой книги, равное значению самого большего количества экземпляров одной книги на складе. Вывести название книги, ее автора, текущее количество экземпляров на складе и количество заказываемых экземпляров книг. Последнему столбцу присвоить имя `Заказ`. В результат не включать книги, которые заказывать не нужно.
```SQL
SELECT title, author, amount,  
    (SELECT MAX(amount) FROM book) - amount AS Заказ
FROM book
WHERE amount <> (SELECT MAX(amount) FROM book)
```
```
+--------------------+------------------+--------+-------+
| title              | author           | amount | Заказ |
+--------------------+------------------+--------+-------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |
+--------------------+------------------+--------+-------+
```
