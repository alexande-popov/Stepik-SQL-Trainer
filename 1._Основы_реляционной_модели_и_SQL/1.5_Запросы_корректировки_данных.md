# 1.5 Запросы корректировки данных
## Добавление записей в таблицу
Допускается вставка нескольких записей одновременно, для этого используется SQL запрос следующего вида:
```SQL
INSERT INTO имя_таблицы(столбец_1, столбец_2, ..., столбец_N)
VALUES
    (значение_1_1, значение_1_2, ..., значение_1_N),
    (значение_2_1, значение_2_2, ..., значение_2_N),
    ...
    (значение_M_1, значение_M_2, ..., значение_M_N);
```
## Добавление записей из другой таблицы
Вместо списка `VALUES` можно передавать записи из другой таблицы, отобранные с помощью запроса на выборку `SELECT`. 
В запросе можно использовать `WHERE`, `GROUP BY`, `ORDER BY`.

**Пример**

Занести все книги из таблицы `supply` в таблицу `book`.
```SQL
INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount 
FROM supply;
```
```
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
| 6       | Лирика                | Пастернак Б.Л.   | 518.99 | 2      |
| 7       | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 8       | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 9       | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
+---------+-----------------------+------------------+--------+--------+
```
Перенеслись даже те позиции, которые в `book` уже есть («Белая гвардия» и «Идиот»). 
Для реляционной модели это нежелательная ситуация. Устранить эту проблему можно с помощью вложенных запросов

## Добавление записей, вложенные запросы
**Пример**

Занести из таблицы `supply` в таблицу `book` только те книги, названия которых отсутствуют в таблице `book`.
```SQL
INSERT INTO book (title, author, price, amount) 
SELECT title, author, price, amount FROM supply
    WHERE title NOT IN (SELECT title FROM book);
```
### Запросы на обновление одного столбца (поля)
Формат простейшего запроса:
```SQL
UPDATE таблица SET поле = выражение
```
В запрос можно включать ключевое слово `WHERE`, задающее условие отбора строк для изменения.

**Пример**

Уменьшить на 30% цену тех книг в таблице book, количество которых меньше 5.
```SQL
UPDATE book 
SET price = 0.7 * price 
WHERE amount < 5;
```
## Запросы на обновление нескольких столбцов (полей)
Формат простейшего запроса:
```SQL
UPDATE таблица SET поле1 = выражение1, поле2 = выражение2
```
**Пример**

В столбце `buy` покупатель указывает количество книг, которые он хочет приобрести. Для каждой книги, выбранной покупателем, необходимо уменьшить ее количество на складе на указанное в столбце `buy` количество, а в столбец `buy` занести 0.

Исходная таблица:
```
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 18  |
+---------+-----------------------+------------------+--------+--------+-----+
```
Исправим таблицу, то есть как бы совершим покупку:
```SQL
UPDATE book 
SET amount = amount - buy,
    buy = 0;
```
Результат:
```
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 2      | 0   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 2      | 0   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | -3     | 0   |
+---------+-----------------------+------------------+--------+--------+-----+
```
### Синтаксис раздела `SET` при использовании функции `IF()`.
Иногда бывает удобно условие записывать не через `WHERE`, а через функцию `IF()`, особенно если для каждого обновляемого столбца свое условие.
Если `условие` выполняется, делай `выражение_1`, иначе делай `выражение_2`.
```SQL
SET столбец = IF(условие, выражение_1, выражение_2)
```
#### Задание
В таблице book необходимо скорректировать значение для покупателя в столбце buy таким образом, чтобы оно не превышало количество экземпляров книг, указанных в столбце amount. А цену тех книг, которые покупатель не заказывал, снизить на 10%.

Начальная таблица та же:
```
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      | 3   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     | 8   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     | 18  |
+---------+-----------------------+------------------+--------+--------+-----+
```
Подправим возможность покупателя заказать только доступное количество книг (15, а не 18 для последней строчки). А также завлечем скидками на то, что он не собирается покупать.
```SQL
UPDATE book
SET buy   = IF(buy > amount, amount, buy),
    price = IF(buy = 0, 0.9 * price, price);
```
```
+---------+-----------------------+------------------+--------+--------+-----+
| book_id | title                 | author           | price  | amount | buy |
+---------+-----------------------+------------------+--------+--------+-----+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      | 0   |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 2      | 0   |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 2      | 0   |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      | 0   |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | -3     | 0   |
+---------+-----------------------+------------------+--------+--------+-----+
```
## Запросы на обновление нескольких таблиц
В запросах на обновление можно использовать несколько таблиц, но тогда
* для столбцов, имеющих одинаковые имена, необходимо указывать имя таблицы: например, `book.price` и `supply.price`;
* все таблицы, используемые в запросе, нужно перечислить после ключевого слова `UPDATE`, даже если не во всех изменяется информация;
* в запросе обязательно условие `WHERE`, в котором указывается условие при котором обновляются данные.

#### Задание
Если в таблице `supply`  есть те же книги, что и в таблице `book`, добавлять эти книги в таблицу `book` не имеет смысла. Необходимо увеличить их количество на значение столбца `amount` таблицы `supply`. Если цены на книгив двух таблицах различаются, то пересчитать их цену (для каждой книги найти сумму цен из таблиц book и supply и разделить на 2).

Изначальные таблицы:
```
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
+-----------+----------------+------------------+--------+--------+
| supply_id | title          | author           | price  | amount |
+-----------+----------------+------------------+--------+--------+
| 1         | Лирика         | Пастернак Б.Л.   | 518.99 | 2      |
| 2         | Черный человек | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия  | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот          | Достоевский Ф.М. | 360.80 | 3      |
+-----------+----------------+------------------+--------+--------+
```
Визуальный анализ говорит, что нужно добавлять "Белую гвардию" и "Идиота". Для "Идиота" также нужно пересчитать цену.
```SQL
UPDATE book, supply
SET book.amount = book.amount + supply.amount,
    book.price = (book.price + supply.price) / 2
WHERE book.title = supply.title AND book.author = supply.author;
```
```
+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 12     |
| 3       | Идиот                 | Достоевский Ф.М. | 410.40 | 13     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 2      |
| 5       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```
