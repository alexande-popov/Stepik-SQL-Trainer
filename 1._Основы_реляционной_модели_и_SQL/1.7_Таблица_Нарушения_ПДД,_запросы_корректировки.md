# 1.7 Таблица "Нарушения ПДД", запросы корректировки

## Использование временного имени таблицы (алиаса)
Алиасы так можно использовать для столбцов и для таблиц.

Для присваивания псевдонима существует 2 варианта: 
* с использованием ключевого слова `AS` 
```SQL
FROM fine AS f, traffic_violation AS tv
```
* а так же и без него
```SQL
FROM fine f, traffic_violation tv
```
После присвоения таблице алиаса, он используется во всех разделах запроса, в котором алиас задан. Например:
```SQL
WHERE f.violation = tv.violation
```

# Задание Step 2
Создать таблицу `fine`.
```SQL
CREATE TABLE fine(
    fine_id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(30),
    number_plate VARCHAR(6),
    violation VARCHAR(50),
    sum_fine DECIMAL(8, 2),
    date_violation DATE,
    date_payment DATE);
```
# Задание Step 3
Вставить строки.
```SQL
INSERT INTO fine (name, number_plate, violation, sum_fine, date_violation, date_payment)
VALUES
  ("Баранов П.Е.", "Р523ВТ", "Превышение скорости(от 40 до 60)", NULL, "2020-02-14", NULL),
  ("Абрамова К.А.", "О111АВ", "Проезд на запрещающий сигнал", NULL, "2020-02-23", NULL),
  ("Яковлев Г.Р.", "Т330ТТ", "Проезд на запрещающий сигнал", NULL, "2020-03-03", NULL);
```
# Задание Step 4 (Использование временного имени таблицы (псевдонима))
**Пример**

Для тех, кто уже оплатил штраф, вывести информацию о том, изменялась ли стандартная сумма штрафа.

Наполнение таблиц:
```
+---------------+--------+------------------------------+----------+----------------+--------------+
| name          | number | violation                    | sum_fine | date_violation | date_payment | 
|               | _plate |                              |          |                |              | 
+---------------+--------+------------------------------+----------+----------------+--------------+
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | 500.00   | 2020-01-12     | 2020-01-17   |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигнал | 1000.00  | 2020-01-14     | 2020-02-27   |
| Яковлев Г.Р.  | Т330ТТ | Превышение скорости(от 20... | 500.00   | 2020-01-23     | 2020-02-23   |
| Яковлев Г.Р.  | М701АА | Превышение скорости(от 20... | NULL     | 2020-01-12     | NULL         |
| Колесов С.П.  | К892АХ | Превышение скорости(от 20... | NULL     | 2020-02-01     | NULL         |
| Баранов П.Е.  | Р523ВТ | Превышение скорости(от 40... | NULL     | 2020-02-14     | NULL         |
| Абрамова К.А. | О111АВ | Проезд на запрещающий сигн...| NULL     | 2020-02-23     | NULL         |
| Яковлев Г.Р.  | Т330ТТ | Проезд на запрещающий сигн...| NULL     | 2020-03-03     | NULL         |
+---------------+--------+------------------------------+----------+----------------+--------------+
+--------------+----------------------------------+----------+
| violation_id | violation                        | sum_fine |
+--------------+----------------------------------+----------+
| 1            | Превышение скорости(от 20 до 40) | 500.00   |
| 2            | Превышение скорости(от 40 до 60) | 1000.00  |
| 3            | Проезд на запрещающий сигнал     | 1000.00  |
+--------------+----------------------------------+----------+
```
Решение:
```SQL
SELECT f.name, f.violation,
    IF (f.sum_fine = tv.sum_fine, "Стандартная сумма штрафа",
    IF (f.sum_fine < tv.sum_fine, "Уменьшенная сумма штрафа", "Увеличенная сумма штрафа") 
        ) AS description
FROM fine f, traffic_violation tv
WHERE f.sum_fine IS NOT NULL AND tv.violation = f.violation;
```
Результат:
```
+---------------+----------------------------------+--------------------------+
| name          | violation                        | description              |
+---------------+----------------------------------+--------------------------+
| Баранов П.Е.  | Превышение скорости(от 40 до 60) | Уменьшенная сумма штрафа |
| Абрамова К.А. | Проезд на запрещающий сигнал     | Стандартная сумма штрафа |
| Яковлев Г.Р.  | Превышение скорости(от 20 до 40) | Стандартная сумма штрафа |
+---------------+----------------------------------+--------------------------+
```
#### Задание
Занести в таблицу `fine` суммы штрафов, которые должен оплатить водитель, в соответствии с данными из таблицы `traffic_violation`. 
При этом суммы заносить только в пустые поля столбца `sum_fine`.

*Замечание*: После ключевого слова `UPDATE` указывается две таблицы, так как они обе задействованы, хоть во во второй ничего не изменяется.  
```SQL
UPDATE fine AS f, traffic_violation AS tv
SET f.sum_fine = tv.sum_fine
WHERE f.sum_fine IS NULL 
  AND f.violation = tv.violation;
```
# Задание Step 5 (Группировка данных по нескольким столбцам)
**Пример**
```SQL
SELECT name, number_plate, violation, count(*)
FROM fine
GROUP BY name, number_plate, violation
ORDER BY name;
```
```
+---------------+--------------+----------------------------------+----------+
| name          | number_plate | violation                        | count(*) |
+---------------+--------------+----------------------------------+----------+
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     | 2        |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) | 2        |
| Колесов С.П.  | К892АХ       | Превышение скорости(от 20 до 40) | 1        |
| Яковлев Г.Р.  | М701АА       | Превышение скорости(от 20 до 40) | 1        |
| Яковлев Г.Р.  | Т330ТТ       | Превышение скорости(от 20 до 40) | 1        |
| Яковлев Г.Р.  | Т330ТТ       | Проезд на запрещающий сигнал     | 1        |
+---------------+--------------+----------------------------------+----------+
```
#### Задание
Вывести фамилию, номер машины и нарушение только для тех водителей, которые на одной машине нарушили одно и то же правило два и более раз. 
При этом учитывать все нарушения, независимо от того оплачены они или нет. 
Информацию отсортировать в алфавитном порядке, сначала по фамилии водителя, потом по номеру машины и, наконец, по нарушению.
```SQL
SELECT name, number_plate, violation
FROM fine
GROUP BY name, number_plate, violation
HAVING count(violation) >= 2
ORDER BY name, number_plate, violation;
```
```
+---------------+--------------+----------------------------------+
| name          | number_plate | violation                        |
+---------------+--------------+----------------------------------+
| Абрамова К.А. | О111АВ       | Проезд на запрещающий сигнал     |
| Баранов П.Е.  | Р523ВТ       | Превышение скорости(от 40 до 60) |
+---------------+--------------+----------------------------------+
```
# Задание Step 6
В таблице `fine` увеличить в два раза сумму неоплаченных штрафов для отобранных на предыдущем шаге записей. 

*Пояснение*: создаем алиас, например `temp`, в которой владываем таблицу прошлого запроса.
И формируем условия сравнения двух таблиц `fine` и `temp`.
```SQL
UPDATE fine,
    (SELECT name, number_plate, violation FROM fine
    GROUP BY name, number_plate, violation
    HAVING COUNT(*) > 1) AS temp
SET sum_fine = sum_fine * 2
WHERE date_payment IS NULL 
    AND fine.name = temp.name
    AND fine.number_plate = temp.number_plate
    AND fine.violation = temp.violation;
```
# Задание Step 7
# Задание Step 8
