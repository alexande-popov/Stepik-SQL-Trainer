# 2.3 Запросы корректировки, соединение таблиц

## Оглавление:
[Запросы на обновление, связанные таблицы](#Запросы-на-обновление,-связанные-таблицы)

[Запросы на добавление, связанные таблицы](#Запросы-на-добавление,-связанные-таблицы)

## Изначальные таблицы
<details>
<summary>Раскрыть</summary>
<tt><blockquote>Таблица book
+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 5      |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 6      |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Таблица supply
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 6      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 7      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+
Таблица author                          Таблица genre
+-----------+------------------+	+----------+-------------+			
| author_id | name_author      |	| genre_id | name_genre  |			
+-----------+------------------+	+----------+-------------+			
| 1         | Булгаков М.А.    |	| 1        | Роман       |			
| 2         | Достоевский Ф.М. |	| 2        | Поэзия      |			
| 3         | Есенин С.А.      |	| 3        | Приключения |			
| 4         | Пастернак Б.Л.   |	+----------+-------------+			
| 5         | Лермонтов М.Ю.   |							
+-----------+------------------+</blockquote></tt>
</details>

[:arrow_up:Оглавление](#Оглавление)

## Запросы на обновление, связанные таблицы
В запросах на обновление можно использовать связанные таблицы:
```SQL
UPDATE таблица_1
     ... JOIN таблица_2
     ON выражение
     ...
SET ...   
WHERE ...;
```
При этом исправлять данные можно во всех используемых в запросе таблицах.

**Пример**

Для книг, которые уже есть на складе (в таблице `book`) по той же цене, что и в поставке (`supply`), увеличить количество на значение, 
указанное в поставке, а также обнулить количество этих книг в поставке.

Этот запрос должен отобрать строки из таблиц `book` и `supply` такие, что у них совпадают и автор, и название книги. 
Но в таблице `supply` фамилия автора записана не числом (`id`), а текстом. 
Следовательно, чтобы выполнить сравнение по фамилии автора нужно "подтянуть" таблицу `author`,  которая связана с `book` по столбцу `author_id`.  
И в логическом выражении, описывающем соединение таблиц, можно будет использовать столбцы из таблиц `book`, `author` и `supply`. 

Если таблицы логически связаны по двум и более столбцам (на рисунке связи обозначены линиями), возможно через другие таблицы, 
условие соединение будет включать связи по нужным столбцам через логический оператор `AND`. 
Например, для следующих таблиц логическую связь по названию и автору:

![pic1](https://ucarecdn.com/3c953b71-fad4-40c0-8ae2-6e43a3e201d0/)

условие соединения можно записать в виде:
```SQL
book INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                          and supply.author = author.name_author
```
Запрос:
```SQL
UPDATE book 
     INNER JOIN author ON author.author_id = book.author_id
     INNER JOIN supply ON book.title = supply.title 
                         and supply.author = author.name_author
SET book.amount = book.amount + supply.amount,
    supply.amount = 0   
WHERE book.price = supply.price;
```
<details>
<summary>Результат</summary><tt>+---------+-----------------------+-----------+----------+--------+--------+
| book_id | title                 | author_id | genre_id | price  | amount |
+---------+-----------------------+-----------+----------+--------+--------+
| 1       | Мастер и Маргарита    | 1         | 1        | 670.99 | 3      |
| 2       | Белая гвардия         | 1         | 1        | 540.50 | 12     |
| 3       | Идиот                 | 2         | 1        | 460.00 | 10     |
| 4       | Братья Карамазовы     | 2         | 1        | 799.01 | 3      |
| 5       | Игрок                 | 2         | 1        | 480.50 | 10     |
| 6       | Стихотворения и поэмы | 3         | 2        | 650.00 | 15     |
| 7       | Черный человек        | 3         | 2        | 570.20 | 12     |
| 8       | Лирика                | 4         | 2        | 518.99 | 2      |
+---------+-----------------------+-----------+----------+--------+--------+
Affected rows: 8

Query result:
+-----------+-----------------------+------------------+--------+--------+
| supply_id | title                 | author           | price  | amount |
+-----------+-----------------------+------------------+--------+--------+
| 1         | Доктор Живаго         | Пастернак Б.Л.   | 380.80 | 4      |
| 2         | Черный человек        | Есенин С.А.      | 570.20 | 0      |
| 3         | Белая гвардия         | Булгаков М.А.    | 540.50 | 0      |
| 4         | Идиот                 | Достоевский Ф.М. | 360.80 | 3      |
| 5         | Стихотворения и поэмы | Лермонтов М.Ю.   | 255.90 | 4      |
| 6         | Остров сокровищ       | Стивенсон Р.Л.   | 599.99 | 5      |
+-----------+-----------------------+------------------+--------+--------+</tt></details>

#### Задание
Для книг, которые уже есть на складе (в таблице `book`), но по другой цене, чем в поставке (`supply`),  
необходимо в таблице `book увеличить` количество на значение, указанное в поставке,  и пересчитать цену (сделать средневзвешенную). 
А в таблице `supply` обнулить количество этих книг.
```SQL
UPDATE book b
         INNER JOIN author a USING(author_id)
         INNER JOIN supply s
             ON b.title = s.title AND
                a.name_author = s.author
SET b.amount = b.amount + s.amount,
    s.amount = 0,
    b.price = ROUND(
        (b.price*b.amount + s.price*s.amount) / (b.amount + s.amount), 
                   2)
WHERE b.price <> s.price;
```
```
+-------+------------------+-----------------+-----------------+-----------+
| title | name_author      | book_new_amount | supp_new_amount | new_price |
+-------+------------------+-----------------+-----------------+-----------+
| Идиот | Достоевский Ф.М. | 13              | 0               | 437.11    |
+-------+------------------+-----------------+-----------------+-----------+
```
  
[:arrow_up:Оглавление](#Оглавление)

## Запросы на добавление, связанные таблицы
Запросом на добавление можно добавить записи, отобранные с помощью запроса на выборку, который включает несколько таблиц:
```SQL
INSERT INTO таблица (список_полей)
SELECT список_полей_из_других_таблиц
FROM 
    таблица_1 
    ... JOIN таблица_2 ON ...
    ...
```

**Пример**

В таблице `supply`  есть новые книги, которых на складе еще не было. Прежде чем добавлять их в таблицу `book`,  
необходимо из таблицы `supply` отобрать новых авторов в таблицу `author`, если таковые имеются.
```SQL
SELECT name_author, supply.author
FROM 
    author 
    RIGHT JOIN supply ON author.name_author = supply.author;
```
Поскольку таблица `author` и поле в таблице `supply` называются одинаково, желательно указывать полную ссылку на поле (`supply.author`), 
чтобы запрос был более читабельным.
```
+------------------+------------------+
| name_author      | author           |
+------------------+------------------+
| Булгаков М.А.    | Булгаков М.А.    |
| Достоевский Ф.М. | Достоевский Ф.М. |
| Есенин С.А.      | Есенин С.А.      |
| Пастернак Б.Л.   | Пастернак Б.Л.   |
| Лермонтов М.Ю.   | Лермонтов М.Ю.   |
| None             | Стивенсон Р.Л.   |
+------------------+------------------+
```
Выполнив правое внутреннее соединение таблиц, получили значение `Null` в поле `name_autho`r в строке того автора, 
которого нет в таблице `author`, в нашем случае это Стивенсон.

Теперь достаточно в запросе задать условие отбора, и список новых авторов готов для включения в таблицу `author`.
```SQL
SELECT supply.author
FROM 
    author 
    RIGHT JOIN supply on author.name_author = supply.author
WHERE name_author IS Null;
```
```
+----------------+
| author         |
+----------------+
| Стивенсон Р.Л. |
+----------------+
```
#### Задание
Включить новых авторов в таблицу `author` с помощью запроса на добавление, а затем вывести все данные из таблицы `author`.  
Новыми считаются авторы, которые есть в таблице `supply`, но нет в таблице `author`.
```SQL
INSERT INTO author (name_author)
SELECT s.author
FROM supply s
     LEFT JOIN author a
            ON s.author = a.name_author
WHERE a.name_author IS NULL
```
[:arrow_up:Оглавление](#Оглавление)



[:arrow_up:Оглавление](#Оглавление)
[:arrow_up:Оглавление](#Оглавление)
[:arrow_up:Оглавление](#Оглавление)
[:arrow_up:Оглавление](#Оглавление)
[:arrow_up:Оглавление](#Оглавление)
[:arrow_up:Оглавление](#Оглавление)
