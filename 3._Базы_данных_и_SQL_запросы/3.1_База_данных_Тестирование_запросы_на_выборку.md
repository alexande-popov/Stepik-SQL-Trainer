# 3.1 База данных «Тестирование», запросы на выборку

## Содрежание
[Создание базы данных](#Создание-базы-данных)

[Работа со строками. `LEFT` и `CONCAT`](#Работа-со-строками-LEFT-и-CONCAT)
___

## Создание базы данных
Концептуальная схема базы данных:

![pic-conc-sch](https://ucarecdn.com/c3a958bc-1805-4da5-b4b9-e77343f65024/)

Логическая схема базы данных:

![pic-log-sch](https://ucarecdn.com/e4669333-8898-434f-b1a5-4fa88b39ae02/)

<details>
<summary>Создание таблиц</summary><tt><blockquote>
DROP TABLE IF EXISTS testing;
DROP TABLE IF EXISTS attempt;
DROP TABLE IF EXISTS student;
DROP TABLE IF EXISTS answer;
DROP TABLE IF EXISTS question;
DROP TABLE IF EXISTS subject;

CREATE TABLE subject
(
    subject_id   INT PRIMARY KEY AUTO_INCREMENT,
    name_subject VARCHAR(30)
);

INSERT INTO subject (name_subject)
VALUES ('Основы SQL'),
       ('Основы баз данных'),
       ('Физика');

CREATE TABLE student
(
    student_id   INT PRIMARY KEY AUTO_INCREMENT,
    name_student VARCHAR(50)
);

INSERT INTO student (name_student)
VALUES ('Баранов Павел'),
       ('Абрамова Катя'),
       ('Семенов Иван'),
       ('Яковлева Галина');

CREATE TABLE attempt
(
    attempt_id   INT PRIMARY KEY AUTO_INCREMENT,
    student_id   INT,
    subject_id   INT,
    date_attempt DATE,
    result       INT,
    FOREIGN KEY (student_id) REFERENCES student (student_id) ON DELETE CASCADE,
    FOREIGN KEY (subject_id) REFERENCES subject (subject_id) ON DELETE CASCADE
);

INSERT INTO attempt (student_id, subject_id, date_attempt, result)
VALUES (1, 2, '2020-03-23', 67),
       (3, 1, '2020-03-23', 100),
       (4, 2, '2020-03-26', 0),
       (1, 1, '2020-04-15', 33),
       (3, 1, '2020-04-15', 67),
       (4, 2, '2020-04-21', 100),
       (3, 1, '2020-05-17', 33);

CREATE TABLE question
(
    question_id   INT PRIMARY KEY AUTO_INCREMENT,
    name_question VARCHAR(100),
    subject_id    INT,
    FOREIGN KEY (subject_id) REFERENCES subject (subject_id) ON DELETE CASCADE
);

INSERT INTO question (name_question, subject_id)
VALUES ('Запрос на выборку начинается с ключевого слова:', 1),
       ('Условие, по которому отбираются записи, задается после ключевого слова:', 1),
       ('Для сортировки используется:', 1),
       ('Какой запрос выбирает все записи из таблицы student:', 1),
       ('Для внутреннего соединения таблиц используется оператор:', 1),
       ('База данных - это:', 2),
       ('Отношение - это:', 2),
       ('Концептуальная модель используется для', 2),
       ('Какой тип данных не допустим в реляционной таблице?', 2);

CREATE TABLE answer
(
    answer_id   INT PRIMARY KEY AUTO_INCREMENT,
    name_answer VARCHAR(100),
    question_id INT,
    is_correct  BOOLEAN,
    FOREIGN KEY (question_id) REFERENCES question (question_id) ON DELETE CASCADE
);

INSERT INTO answer (name_answer, question_id, is_correct)
VALUES ('UPDATE', 1, FALSE),
       ('SELECT', 1, TRUE),
       ('INSERT', 1, FALSE),
       ('GROUP BY', 2, FALSE),
       ('FROM', 2, FALSE),
       ('WHERE', 2, TRUE),
       ('SELECT', 2, FALSE),
       ('SORT', 3, FALSE),
       ('ORDER BY', 3, TRUE),
       ('RANG BY', 3, FALSE),
       ('SELECT * FROM student', 4, TRUE),
       ('SELECT student', 4, FALSE),
       ('INNER JOIN', 5, TRUE),
       ('LEFT JOIN', 5, FALSE),
       ('RIGHT JOIN', 5, FALSE),
       ('CROSS JOIN', 5, FALSE),
       ('совокупность данных, организованных по определенным правилам', 6, TRUE),
       ('совокупность программ для хранения и обработки больших массивов информации', 6, FALSE),
       ('строка', 7, FALSE),
       ('столбец', 7, FALSE),
       ('таблица', 7, TRUE),
       ('обобщенное представление пользователей о данных', 8, TRUE),
       ('описание представления данных в памяти компьютера', 8, FALSE),
       ('база данных', 8, FALSE),
       ('file', 9, TRUE),
       ('INT', 9, FALSE),
       ('VARCHAR', 9, FALSE),
       ('DATE', 9, FALSE);

CREATE TABLE testing
(
    testing_id  INT PRIMARY KEY AUTO_INCREMENT,
    attempt_id  INT,
    question_id INT,
    answer_id   INT,
    FOREIGN KEY (attempt_id) REFERENCES attempt (attempt_id) ON DELETE CASCADE,
    FOREIGN KEY (question_id) REFERENCES question (question_id) ON DELETE CASCADE,
    FOREIGN KEY (answer_id) REFERENCES answer (answer_id) ON DELETE CASCADE
);

INSERT INTO testing (attempt_id, question_id, answer_id)
VALUES (1, 9, 25),
       (1, 7, 19),
       (1, 6, 17),
       (2, 3, 9),
       (2, 1, 2),
       (2, 4, 11),
       (3, 6, 18),
       (3, 8, 24),
       (3, 9, 28),
       (4, 1, 2),
       (4, 5, 16),
       (4, 3, 10),
       (5, 2, 6),
       (5, 1, 2),
       (5, 4, 12),
       (6, 6, 17),
       (6, 8, 22),
       (6, 7, 21),
       (7, 1, 3),
       (7, 4, 11),
       (7, 5, 16);
</blockquote></tt></details>

<details>
<summary>Таблицы</summary><tt><blockquote>
Query result: subject 
+------------+-------------------+
| subject_id | name_subject      |
+------------+-------------------+
| 1          | Основы SQL        |
| 2          | Основы баз данных |
| 3          | Физика            |
+------------+-------------------+
Query result: question 
+-------------+-------------------------------------------------------------------------+------------+
| question_id | name_question                                                           | subject_id |
+-------------+-------------------------------------------------------------------------+------------+
| 1           | Запрос на выборку начинается с ключевого слова:                         | 1          |
| 2           | Условие, по которому отбираются записи, задается после ключевого слова: | 1          |
| 3           | Для сортировки используется:                                            | 1          |
| 4           | Какой запрос выбирает все записи из таблицы student:                    | 1          |
| 5           | Для внутреннего соединения таблиц используется оператор:                | 1          |
| 6           | База данных - это:                                                      | 2          |
| 7           | Отношение - это:                                                        | 2          |
| 8           | Концептуальная модель используется для                                  | 2          |
| 9           | Какой тип данных не допустим в реляционной таблице?                     | 2          |
+-------------+-------------------------------------------------------------------------+------------+
Query result: answer 
+-----------+---------------------------------------------------------------------------+-------------+------------+
| answer_id | name_answer                                                               | question_id | is_correct |
+-----------+---------------------------------------------------------------------------+-------------+------------+
| 1         | UPDATE                                                                    | 1           | 0          |
| 2         | SELECT                                                                    | 1           | 1          |
| 3         | INSERT                                                                    | 1           | 0          |
| 4         | GROUP BY                                                                  | 2           | 0          |
| 5         | FROM                                                                      | 2           | 0          |
| 6         | WHERE                                                                     | 2           | 1          |
| 7         | SELECT                                                                    | 2           | 0          |
| 8         | SORT                                                                      | 3           | 0          |
| 9         | ORDER BY                                                                  | 3           | 1          |
| 10        | RANG BY                                                                   | 3           | 0          |
| 11        | SELECT * FROM student                                                     | 4           | 1          |
| 12        | SELECT student                                                            | 4           | 0          |
| 13        | INNER JOIN                                                                | 5           | 1          |
| 14        | LEFT JOIN                                                                 | 5           | 0          |
| 15        | RIGHT JOIN                                                                | 5           | 0          |
| 16        | CROSS JOIN                                                                | 5           | 0          |
| 17        | совокупность данных, организованныхпо определенным правилам               | 6           | 1          |
| 18        | совокупность программ для хранения иобработки больших массивов информации | 6           | 0          |
| 19        | строка                                                                    | 7           | 0          |
| 20        | столбец                                                                   | 7           | 0          |
| 21        | таблица                                                                   | 7           | 1          |
| 22        | обобщенное представление пользователей о данных                           | 8           | 1          |
| 23        | описание представления данных в памяти компьютера                         | 8           | 0          |
| 24        | база данных                                                               | 8           | 0          |
| 25        | file                                                                      | 9           | 1          |
| 26        | INT                                                                       | 9           | 0          |
| 27        | VARCHAR                                                                   | 9           | 0          |
| 28        | DATE                                                                      | 9           | 0          |
+-----------+---------------------------------------------------------------------------+-------------+------------+
Query result: student 
+------------+-----------------+
| student_id | name_student    |
+------------+-----------------+
| 1          | Баранов Павел   |
| 2          | Абрамова Катя   |
| 3          | Семенов Иван    |
| 4          | Яковлева Галина |
+------------+-----------------+
Query result: attempt 
+------------+------------+------------+--------------+--------+
| attempt_id | student_id | subject_id | date_attempt | result |
+------------+------------+------------+--------------+--------+
| 1          | 1          | 2          | 2020-03-23   | 67     |
| 2          | 3          | 1          | 2020-03-23   | 100    |
| 3          | 4          | 2          | 2020-03-26   | 0      |
| 4          | 1          | 1          | 2020-04-15   | 33     |
| 5          | 3          | 1          | 2020-04-15   | 67     |
| 6          | 4          | 2          | 2020-04-21   | 100    |
| 7          | 3          | 1          | 2020-05-17   | 33     |
+------------+------------+------------+--------------+--------+
Query result: testing
+------------+------------+-------------+-----------+
| testing_id | attempt_id | question_id | answer_id |
+------------+------------+-------------+-----------+
| 1          | 1          | 9           | 25        |
| 2          | 1          | 7           | 19        |
| 3          | 1          | 6           | 17        |
| 4          | 2          | 3           | 9         |
| 5          | 2          | 1           | 2         |
| 6          | 2          | 4           | 11        |
| 7          | 3          | 6           | 18        |
| 8          | 3          | 8           | 24        |
| 9          | 3          | 9           | 28        |
| 10         | 4          | 1           | 2         |
| 11         | 4          | 5           | 16        |
| 12         | 4          | 3           | 10        |
| 13         | 5          | 2           | 6         |
| 14         | 5          | 1           | 2         |
| 15         | 5          | 4           | 12        |
| 16         | 6          | 6           | 17        |
| 17         | 6          | 8           | 22        |
| 18         | 6          | 7           | 21        |
| 19         | 7          | 1           | 3         |
| 20         | 7          | 4           | 11        |
| 21         | 7          | 5           | 16        |
+------------+------------+-------------+-----------+
</blockquote></tt></details>

[:arrow_up:Оглавление](#Оглавление)

## Задание Step 2
Вывести студентов, которые сдавали дисциплину «Основы баз данных», указать дату попытки и результат. Информацию вывести по убыванию результатов тестирования.
```SQL
SELECT name_student, date_attempt, result
FROM student 
INNER JOIN attempt USING(student_id)
INNER JOIN subject USING(subject_id)
WHERE name_subject = "Основы баз данных"
ORDER BY result DESC;
```
```
+-----------------+--------------+--------+
| name_student    | date_attempt | result |
+-----------------+--------------+--------+
| Яковлева Галина | 2020-04-21   | 100    |
| Баранов Павел   | 2020-03-23   | 67     |
| Яковлева Галина | 2020-03-26   | 0      |
+-----------------+--------------+--------+
```

## Задание Step 3
Вывести, сколько попыток сделали студенты по каждой дисциплине, а также средний результат попыток, который округлить до 2 знаков после запятой. Под результатом попытки понимается процент правильных ответов на вопросы теста, который занесен в столбец `result`.  В результат включить название дисциплины, а также вычисляемые столбцы `Количество` и `Среднее`. Информацию вывести по убыванию средних результатов.
```SQL
SELECT name_subject, COUNT(result) AS Количество, ROUND(AVG(result),2) AS Среднее
FROM subject LEFT JOIN attempt USING(subject_id)
GROUP BY name_subject
ORDER BY Среднее DESC;
```
```
+-------------------+------------+---------+
| name_subject      | Количество | Среднее |
+-------------------+------------+---------+
| Основы SQL        | 4          | 58.25   |
| Основы баз данных | 3          | 55.67   |
| Физика            | 0          | NULL    |
+-------------------+------------+---------+
```
[:arrow_up:Оглавление](#Оглавление)

## Задание Step 4
Вывести студентов (различных студентов), имеющих максимальные результаты попыток . Информацию отсортировать в алфавитном порядке по фамилии студента.
```SQL
SELECT DISTINCT name_student, result
FROM       student 
INNER JOIN attempt USING(student_id)
WHERE result = (SELECT result FROM attempt ORDER BY result DESC LIMIT 1)
ORDER BY name_student;
```
```
+-----------------+--------+
| name_student    | result |
+-----------------+--------+
| Семенов Иван    | 100    |
| Яковлева Галина | 100    |
+-----------------+--------+
```

## Задание Step 5
Если студент совершал несколько попыток по одной и той же дисциплине, то вывести разницу в днях между первой и последней попыткой. В результат включить фамилию и имя студента, название дисциплины и вычисляемый столбец `Интервал`. Информацию вывести по возрастанию разницы. Студентов, сделавших одну попытку по дисциплине, не учитывать. 
```SQL
SELECT name_student, name_subject,
       DATEDIFF(MAX(date_attempt), MIN(date_attempt)) AS Интервал
FROM       attempt
INNER JOIN subject USING(subject_id)
INNER JOIN student USING(student_id)
GROUP BY student_id, subject_id
HAVING COUNT(subject_id) > 1
ORDER BY Интервал;
```
```
+-----------------+-------------------+----------+
| name_student    | name_subject      | Интервал |
+-----------------+-------------------+----------+
| Яковлева Галина | Основы баз данных | 26       |
| Семенов Иван    | Основы SQL        | 55       |
+-----------------+-------------------+----------+
```
[:arrow_up:Оглавление](#Оглавление)

## Задание Step 6
Студенты могут тестироваться по одной или нескольким дисциплинам (не обязательно по всем). Вывести дисциплину и количество уникальных студентов (столбец назвать `Количество`), которые по ней проходили тестирование . Информацию отсортировать сначала по убыванию количества, а потом по названию дисциплины. В результат включить и дисциплины, тестирование по которым студенты еще не проходили, в этом случае указать количество студентов 0.
```SQL
SELECT name_subject, COUNT(DISTINCT student_id) AS Количество
FROM      subject
LEFT JOIN attempt USING(subject_id)
GROUP BY subject_id
ORDER BY Количество DESC, name_subject;
```
Стоит обратить внимание, что сортировть надо по уникальным студентам, то есть учитывать пересдачи: `COUNT(DISTINCT student_id)`.
```
+-------------------+------------+
| name_subject      | Количество |
+-------------------+------------+
| Основы SQL        | 2          |
| Основы баз данных | 2          |
| Физика            | 0          |
+-------------------+------------+
```
## Задание Step 7
Случайным образом отберите 3 вопроса по дисциплине «Основы баз данных». В результат включите столбцы `question_id` и` name_question`.

**Пояснение**

Для выбора случайных вопросов можно отсортировать вопросы в случайном порядке:
```SQL
ORDER BY RAND()
```
Запрос
```SQL
SELECT question_id, name_question
FROM question
INNER JOIN subject USING(subject_id)
WHERE name_subject LIKE "Основы баз данных"
ORDER BY RAND()
LIMIT 3;
```
```
+-------------+----------------------------------------+
| question_id | name_question                          |
+-------------+----------------------------------------+
| 8           | Концептуальная модель используется для |
| 6           | База данных - это:                     |
| 7           | Отношение - это:                       |
+-------------+----------------------------------------+
```

[:arrow_up:Оглавление](#Оглавление)

## Задание Step 8
Вывести вопросы, которые были включены в тест для Семенова Ивана по дисциплине «Основы SQL» 2020-05-17  (значение `attempt_id` для этой попытки равно 7). Указать, какой ответ дал студент и правильный он или нет (вывести `Верно` или `Неверно`). В результат включить вопрос, ответ и вычисляемый столбец  `Результат`.
```SQL
SELECT name_question, name_answer,
       IF(is_correct = 1, "Верно", "Неверно") AS Результат
FROM testing
INNER JOIN question USING(question_id)
INNER JOIN answer USING(answer_id)
WHERE attempt_id = 7;
```
```
+----------------------------------------------------------+-----------------------+-----------+
| name_question                                            | name_answer           | Результат |
+----------------------------------------------------------+-----------------------+-----------+
| Запрос на выборку начинается с ключевого слова:          | INSERT                | Неверно   |
| Какой запрос выбирает все записи из таблицы student:     | SELECT * FROM student | Верно     |
| Для внутреннего соединения таблиц используется оператор: | CROSS JOIN            | Неверно   |
+----------------------------------------------------------+-----------------------+-----------+
```
## Задание Step 9
Посчитать результаты тестирования. Результат попытки вычислить как количество правильных ответов, деленное на 3 (количество вопросов в каждой попытке) и умноженное на 100. Результат округлить до двух знаков после запятой. Вывести фамилию студента, название предмета, дату и результат. Последний столбец назвать `Результат`. Информацию отсортировать сначала по фамилии студента, потом по убыванию даты попытки.
```SQL
SELECT name_student, name_subject, date_attempt,
       ROUND(SUM(is_correct / 3 * 100), 2) AS Результат
FROM testing
INNER JOIN question USING(question_id)
INNER JOIN answer   USING(answer_id)
INNER JOIN attempt  USING(attempt_id)
INNER JOIN student  USING(student_id)
INNER JOIN subject  ON attempt.subject_id = subject.subject_id
GROUP BY attempt_id
ORDER BY name_student, date_attempt DESC;
```
```
+-----------------+-------------------+--------------+-----------+
| name_student    | name_subject      | date_attempt | Результат |
+-----------------+-------------------+--------------+-----------+
| Баранов Павел   | Основы SQL        | 2020-04-15   | 33.33     |
| Баранов Павел   | Основы баз данных | 2020-03-23   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-05-17   | 33.33     |
| Семенов Иван    | Основы SQL        | 2020-04-15   | 66.67     |
| Семенов Иван    | Основы SQL        | 2020-03-23   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-04-21   | 100.00    |
| Яковлева Галина | Основы баз данных | 2020-03-26   | 0.00      |
+-----------------+-------------------+--------------+-----------+
```
[:arrow_up:Оглавление](#Оглавление)

### Работа со строками. `LEFT` и `CONCAT`.
Чтобы выделить крайние левые n символов из строки используется функция `LEFT(строка, n)`:
```SQL
LEFT("abcde", 3) -> "abc"
```
Соединение строк осуществляется с помощью функции `CONCAT(строка_1, строка_2)`:
```SQL
CONCAT("ab","cd") -> "abcd"
```


[:arrow_up:Оглавление](#Оглавление)
