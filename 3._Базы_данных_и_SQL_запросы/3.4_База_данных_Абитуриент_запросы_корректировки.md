# 3.4 База данных «Абитуриент», запросы корректировки

## Оглавление

[Создание базы данных](#Создание-базы-данных)

[Задание Step 2](#Задание-Step-2)

[Задание Step 3](#Задание-Step-3)

[Задание Step 4](#Задание-Step-4)

[Задание Step 5](#Задание-Step-5)

[Изменение структуры таблицы с `ALTER TABLE`](#Изменение-структуры-таблицы-с-ALTER-TABLE)

## Создание базы данных

### Предметная область

Университет состоит из совокупности факультетов (школ). Поступление абитуриентов осуществляется на образовательные программы по результатам Единого государственного экзамена (ЕГЭ). Каждая образовательная программа относится к определенному факультету, для нее определены необходимые для поступления предметы ЕГЭ, минимальный балл по этим предметам, а также план набора (количество мест) на образовательную программу.

В приемную комиссию абитуриенты подают заявления на образовательную программу, каждый абитуриент может выбрать несколько образовательных программ (но не более трех). В заявлении указывается фамилия, имя, отчество абитуриента, а также его достижения: получил ли он медаль за обучение в школе, имеет ли значок ГТО и пр. При этом за каждое достижение определен дополнительный балл. Абитуриент предоставляет сертификат с результатами сдачи  ЕГЭ. Если абитуриент выбирает образовательную программу, то у него обязательно должны быть сданы предметы, определенные на эту программу, причем балл должен быть не меньше минимального по данному предмету.

Зачисление абитуриентов осуществляется так: сначала вычисляется сумма баллов по предметам на каждую образовательную программу, добавляются баллы достижения, затем абитуриенты сортируются в порядке убывания суммы баллов и отбираются первые по количеству мест, определенному планом набора.

### Концептуальная схема базы данных

![pic-conc](https://ucarecdn.com/b39b62db-8870-428b-a279-e5e0d5241195/)

### Логическая схема базы данных

![pic-logi](https://ucarecdn.com/12fe86b0-6e53-4d8b-ba52-64f48d692adb/)

<details>
<summary>Создание таблиц</summary><tt><blockquote>
create table department(
department_id INT PRIMARY KEY AUTO_INCREMENT,
name_department VARCHAR(30)
);

insert into department(name_department)
values('Инженерная школа'),
	('Школа естественных наук');

create table subject(
subject_id INT PRIMARY KEY AUTO_INCREMENT,
name_subject VARCHAR(30)
);

insert into subject(name_subject)
values ('Русский язык'),
	   ('Математика'),
       ('Физика'),
       ('Информатика');
       
create table program(
	program_id INT PRIMARY KEY AUTO_INCREMENT,
    name_program VARCHAR(50),
    department_id INT,
    plan INT,
    FOREIGN KEY (department_id) REFERENCES department (department_id));
    
insert into program(name_program,department_id,plan)
values 
	('Прикладная математика и информатика',2,2),
    ('Математика и компьютерные науки',2,1),
    ('Прикладная механика',1,2),
    ('	Мехатроника и робототехника',1,3)
    ;
    
         
create table enrollee(
	enrollee_id INT PRIMARY KEY AUTO_INCREMENT,
    name_enrollee varchar(50)
    );
insert into enrollee(name_enrollee)
values
	('Баранов Павел'),
    ('Абрамова Катя'),
    ('Семенов Иван'),
    ('Яковлева Галина'),
    ('Попов Илья'),
    ('Степанова Дарья')
    ;

create table achievement(
	achievement_id INT PRIMARY KEY AUTO_INCREMENT,
    name_achievement VARCHAR(30),
    bonus INT
    );
insert into achievement(name_achievement,bonus)
values
	('Золотая медаль',5),
    ('Серебряная медаль',3),
    ('Золотой значок ГТО',3),
    ('Серебряный значок ГТО',1)
    ;

create table enrollee_achievement(
	enrollee_achiev_id INT PRIMARY KEY AUTO_INCREMENT,
    enrollee_id INT,
    achievement_id INT,
    FOREIGN KEY (enrollee_id) REFERENCES enrollee (enrollee_id),
    FOREIGN KEY (achievement_id) REFERENCES achievement(achievement_id));
    
insert into enrollee_achievement(enrollee_id,achievement_id)
values (1,2),
	   (1,3),
       (3,1),
       (4,4),
       (5,1),
       (5,3);

create table program_subject(
	program_subject_id INT PRIMARY KEY AUTO_INCREMENT,
    program_id INT,
    subject_id INT,
    min_result INT,
    foreign key (program_id) references program (program_id),
    foreign key (subject_id) references subject (subject_id));
    
insert into program_subject (program_id,subject_id,min_result)
values  (1,1,40),
		(1,2,50),
        (1,4,60),
        (2,1,30),
        (2,2,50),
        (2,4,60),
        (3,1,30),
        (3,2,45),
        (3,3,45),
        (4,1,40),
        (4,2,45),
        (4,3,45);


create table program_enrollee(
	program_enrollee_id INT PRIMARY KEY AUTO_INCREMENT,
    program_id INT,
    enrollee_id INT,
    foreign key (program_id) references program (program_id),
    foreign key (enrollee_id) references enrollee (enrollee_id)
    );
    
insert into program_enrollee(program_id,enrollee_id)
values  (3,1),
		(4,1),
        (1,1),
        (2,2),
        (1,2),
        (1,3),
        (2,3),
        (4,3),
        (3,4),
        (3,5),
        (4,5),
        (2,6),
        (3,6),
        (4,6);

create table enrollee_subject(
	enrollee_subject_id INT PRIMARY KEY AUTO_INCREMENT,
    enrollee_id INT,
    subject_id INT,
    result INT,
    foreign key (enrollee_id) references enrollee (enrollee_id),
    foreign key (subject_id) references subject (subject_id)
    );
    
insert into enrollee_subject(enrollee_id,subject_id,result)
values 
		(1,1,68),
        (1,2,70),
        (1,3,41),
        (1,4,75),
        (2,1,75),
        (2,2,70),
        (2,4,81),
        (3,1,85),
        (3,2,67),
        (3,3,90),
        (3,4,78),
        (4,1,82),
        (4,2,86),
        (4,3,70),
        (5,1,65),
        (5,2,67),
        (5,3,60),
        (6,1,90),
        (6,2,92),
        (6,3,88),
        (6,4,94);
</blockquote></tt></details>

<details>
<summary>Содержание таблиц</summary><tt><blockquote>
Query result: department
+---------------+-------------------------+
| department_id | name_department         |
+---------------+-------------------------+
| 1             | Инженерная школа        |
| 2             | Школа естественных наук |
+---------------+-------------------------+
Query result:program
+------------+-------------------------------------+---------------+------+
| program_id | name_program                        | department_id | plan |
+------------+-------------------------------------+---------------+------+
| 1          | Прикладная математика и информатика | 2             | 2    |
| 2          | Математика и компьютерные науки     | 2             | 1    |
| 3          | Прикладная механика                 | 1             | 2    |
| 4          | Мехатроника и робототехника         | 1             | 3    |
+------------+-------------------------------------+---------------+------+
Query result: program_enrollee
+---------------------+------------+-------------+
| program_enrollee_id | program_id | enrollee_id |
+---------------------+------------+-------------+
| 1                   | 3          | 1           |
| 2                   | 4          | 1           |
| 3                   | 1          | 1           |
| 4                   | 2          | 2           |
| 5                   | 1          | 2           |
| 6                   | 1          | 3           |
| 7                   | 2          | 3           |
| 8                   | 4          | 3           |
| 9                   | 3          | 4           |
| 10                  | 3          | 5           |
| 11                  | 4          | 5           |
| 12                  | 2          | 6           |
| 13                  | 3          | 6           |
| 14                  | 4          | 6           |
+---------------------+------------+-------------+
Query result: program_subject
+--------------------+------------+------------+------------+
| program_subject_id | program_id | subject_id | min_result |
+--------------------+------------+------------+------------+
| 1                  | 1          | 1          | 40         |
| 2                  | 1          | 2          | 50         |
| 3                  | 1          | 4          | 60         |
| 4                  | 2          | 1          | 30         |
| 5                  | 2          | 2          | 50         |
| 6                  | 2          | 4          | 60         |
| 7                  | 3          | 1          | 30         |
| 8                  | 3          | 2          | 45         |
| 9                  | 3          | 3          | 45         |
| 10                 | 4          | 1          | 40         |
| 11                 | 4          | 2          | 45         |
| 12                 | 4          | 3          | 45         |
+--------------------+------------+------------+------------+
Query result: subject
+------------+--------------+
| subject_id | name_subject |
+------------+--------------+
| 1          | Русский язык |
| 2          | Математика   |
| 3          | Физика       |
| 4          | Информатика  |
+------------+--------------+
Query result: enrollee
+-------------+-----------------+
| enrollee_id | name_enrollee   |
+-------------+-----------------+
| 1           | Баранов Павел   |
| 2           | Абрамова Катя   |
| 3           | Семенов Иван    |
| 4           | Яковлева Галина |
| 5           | Попов Илья      |
| 6           | Степанова Дарья |
+-------------+-----------------+
Query result: enrollee_achievement
+--------------------+-------------+----------------+
| enrollee_achiev_id | enrollee_id | achievement_id |
+--------------------+-------------+----------------+
| 1                  | 1           | 2              |
| 2                  | 1           | 3              |
| 3                  | 3           | 1              |
| 4                  | 4           | 4              |
| 5                  | 5           | 1              |
| 6                  | 5           | 3              |
+--------------------+-------------+----------------+
Query result: achievement
+----------------+-----------------------+-------+
| achievement_id | name_achievement      | bonus |
+----------------+-----------------------+-------+
| 1              | Золотая медаль        | 5     |
| 2              | Серебряная медаль     | 3     |
| 3              | Золотой значок ГТО    | 3     |
| 4              | Серебряный значок ГТО | 1     |
+----------------+-----------------------+-------+
Affected rows: 4
</blockquote></tt></details>

[:arrow_up:Оглавление](#Оглавление)

## Задание Step 2
Создать вспомогательную таблицу `applicant`,  куда включить id образовательной программы,  id абитуриента, сумму баллов абитуриентов (столбец `itog`) в отсортированном сначала по id образовательной программы, а потом по убыванию суммы баллов виде.
```SQL
CREATE TABLE applicant
SELECT program_id, enrollee_id, SUM(result) as itog
FROM program_subject
INNER JOIN enrollee_subject USING(subject_id)
INNER JOIN program_enrollee USING(program_id, enrollee_id)
GROUP BY program_id, enrollee_id
ORDER BY program_id, itog DESC;
```
```
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 3          | 1           | 179  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |
| 4          | 1           | 179  |
+------------+-------------+------+
```
## Задание Step 3
Из таблицы `applicant`,  созданной на предыдущем шаге, удалить записи, если абитуриент на выбранную образовательную программу не набрал минимального балла хотя бы по одному предмету.
```SQL
DELETE FROM applicant
WHERE (program_id, enrollee_id) IN 
    (
    SELECT program_id, enrollee_id 
    FROM program_subject
    INNER JOIN enrollee_subject USING(subject_id)
    WHERE min_result > result
    );
```
```
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 230  |
| 1          | 2           | 226  |
| 1          | 1           | 213  |
| 2          | 6           | 276  |
| 2          | 3           | 230  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 238  |
| 3          | 5           | 192  |
| 4          | 6           | 270  |
| 4          | 3           | 242  |
| 4          | 5           | 192  |
+------------+-------------+------+
```
Альтернатива:
```SQL
DELETE FROM applicant
USING applicant JOIN program_subject USING(program_id)
                JOIN enrollee_subject USING(enrollee_id, subject_id)
WHERE result < min_result;
```
Альтернатива:
```SQL
DELETE applicant
FROM applicant
JOIN program_subject USING(program_id)
JOIN enrollee_subject USING(enrollee_id, subject_id)
WHERE result < min_result;
```
[:arrow_up:Оглавление](#Оглавление)

## Задание Step 4
Повысить итоговые баллы абитуриентов в таблице `applicant` на значения дополнительных баллов.
```SQL
UPDATE applicant
LEFT JOIN (
           SELECT enrollee_id, SUM(bonus) AS bonus
           FROM achievement
           INNER JOIN enrollee_achievement USING(achievement_id)
           GROUP BY enrollee_id
          ) AS bonus USING(enrollee_id)
SET itog = itog + bonus
WHERE bonus IS NOT NULL;
```
```
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |
+------------+-------------+------+
```
Еще вариант:
```SQL
UPDATE applicant        
   SET itog = itog + (SELECT IFNULL(SUM(bonus), 0)
                        FROM enrollee_achievement
                             JOIN achievement USING(achievement_id)
                       WHERE enrollee_id = applicant.enrollee_id);
 
 SELECT * FROM applicant;
```
## Задание Step 5
Поскольку при добавлении дополнительных баллов, абитуриенты по каждой образовательной программе могут следовать не в порядке убывания суммарных баллов, необходимо создать новую таблицу `applicant_order` на основе таблицы `applicant`. При создании таблицы данные нужно отсортировать сначала по id образовательной программы, потом по убыванию итогового балла. А таблицу `applicant`, которая была создана как вспомогательная, необходимо удалить.
```SQL
CREATE TABLE applicant_order
SELECT * FROM applicant
ORDER BY program_id, itog DESC;

DROP TABLE applicant;
```
```
+------------+-------------+------+
| program_id | enrollee_id | itog |
+------------+-------------+------+
| 1          | 3           | 235  |
| 1          | 2           | 226  |
| 1          | 1           | 219  |
| 2          | 6           | 276  |
| 2          | 3           | 235  |
| 2          | 2           | 226  |
| 3          | 6           | 270  |
| 3          | 4           | 239  |
| 3          | 5           | 200  |
| 4          | 6           | 270  |
| 4          | 3           | 247  |
| 4          | 5           | 200  |
+------------+-------------+------+
```
[:arrow_up:Оглавление](#Оглавление)

## Изменение структуры таблицы с `ALTER TABLE`
Для изменения структуры таблицы используется оператор `ALTER TABLE`. С его помощью можно вставить новый столбец, удалить существующий, переименовать столбец и пр.

Для вставки нового столбца используется SQL запросы:
```SQL
ALTER TABLE таблица ADD имя_столбца тип; - вставляет столбец после последнего
ALTER TABLE таблица ADD имя_столбца тип FIRST; - вставляет столбец перед первым
ALTER TABLE таблица ADD имя_столбца тип AFTER имя_столбца_1; - вставляет столбец после укзанного столбца
```
Для удаления столбца используется SQL запросы:
```SQL
ALTER TABLE таблица DROP COLUMN имя_столбца; - удаляет столбец с заданным именем
ALTER TABLE таблица DROP имя_столбца; - ключевое слово COLUMN не обязательно указывать
ALTER TABLE таблица DROP имя_столбца,
                    DROP имя_столбца_1; - удаляет два столбца
```
Для переименования столбца используется  запрос (тип данных указывать обязательно):
```SQL
ALTER TABLE таблица CHANGE имя_столбца новое_имя_столбца ТИП ДАННЫХ;
```
Для изменения типа  столбца используется запрос (два раза указывать имя столбца обязательно): 
```SQL
ALTER TABLE таблица CHANGE имя_столбца имя_столбца НОВЫЙ_ТИП_ДАННЫХ;
```
[:arrow_up:Оглавление](#Оглавление)

## Задание Step 6
Включить в таблицу `applicant_order` новый столбец `str_id` целого типа , расположить его перед первым.
```SQL
ALTER TABLE applicant_order ADD str_id INT FIRST;
```
```
+--------+------------+-------------+------+
| str_id | program_id | enrollee_id | itog |
+--------+------------+-------------+------+
| Null   | 1          | 3           | 235  |
| Null   | 1          | 2           | 226  |
| Null   | 1          | 1           | 219  |
| Null   | 2          | 6           | 276  |
| Null   | 2          | 3           | 235  |
| Null   | 2          | 2           | 226  |
| Null   | 3          | 6           | 270  |
| Null   | 3          | 4           | 239  |
| Null   | 3          | 5           | 200  |
| Null   | 4          | 6           | 270  |
| Null   | 4          | 3           | 247  |
| Null   | 4          | 5           | 200  |
+--------+------------+-------------+------+
```


[:arrow_up:Оглавление](#Оглавление)[:arrow_up:Оглавление](#Оглавление)[:arrow_up:Оглавление](#Оглавление)
